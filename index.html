<!DOCTYPE html>
<html>
<head>
    <title>Indoor Air Risk Monitoring System - Advanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body{font-family:Arial,sans-serif;background:#f4f6f9;margin:0;padding:20px;}
        h1{text-align:center;}
        .card-container{display:flex;justify-content:space-around;margin-top:20px;flex-wrap:wrap;}
        .card{background:white;padding:15px;margin:10px;border-radius:10px;width:180px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,0.1);transition:0.3s ease;}
        #riskBox{text-align:center;margin-top:20px;padding:25px;border-radius:12px;font-size:24px;font-weight:bold;color:white;transition:0.3s ease;}
        #explanation{text-align:center;margin-top:10px;font-style:italic;}
        .section{margin-top:30px;}
        table{width:100%;background:white;border-radius:8px;padding:10px;}
        th,td{padding:8px;text-align:center;}
        .emergency{text-align:center;margin-top:20px;}
        .emergency button{background:red;color:white;padding:12px 20px;font-size:16px;border:none;border-radius:8px;cursor:pointer;}
        canvas{background:white;border-radius:8px;padding:10px;}
    </style>
</head>
<body>
    <audio id="alarmSound" src="{{ url_for('static', filename='alarm.mp3') }}"></audio>
    <h1>Indoor Air Risk Monitoring System - Advanced</h1>
    <div id="riskBox">Loading...</div>
    <div id="explanation"></div>
    <div class="card-container">
        <div class="card">LPG<br><span id="lpg">--</span></div>
        <div class="card">Temperature<br><span id="temp">--</span></div>
        <div class="card">Humidity<br><span id="humidity">--</span></div>
        <div class="card">Alcohol<br><span id="alcohol">--</span></div>
    </div>
    <div class="section">
        <h3>Risk Contribution Breakdown</h3>
        <table>
            <tr><th>LPG</th><th>Temp</th><th>Humidity</th><th>Alcohol</th></tr>
            <tr><td id="b_lpg">--</td><td id="b_temp">--</td><td id="b_humidity">--</td><td id="b_alcohol">--</td></tr>
        </table>
    </div>
    <div class="section"><h3>Risk Trend</h3><canvas id="riskChart"></canvas></div>
    <div class="section"><h3>Risk Factor Pie</h3><canvas id="factorPie"></canvas></div>
    <div class="section"><h3>Incident Log & Stats</h3>
        <table><tr><th>Time</th><th>Status</th><th>Reason</th></tr><tbody id="incidentTable"></tbody></table>
        <div id="stats"></div>
    </div>
    <div class="emergency"><button onclick="callEmergency()">ðŸš¨ Call Emergency (112)</button></div>

<script>
const alarm=document.getElementById("alarmSound");
let chart,pieChart,riskHistory=[],predictedHistory=[];
document.body.addEventListener("click",()=>{alarm.play().then(()=>alarm.pause()).catch(()=>{});},{once:true});

const ctx=document.getElementById('riskChart').getContext('2d');
chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[
    {label:'Actual Risk %',data:[],borderColor:'red',fill:false},
    {label:'Predicted Risk %',data:[],borderColor:'blue',borderDash:[5,5],fill:false}
]}});
pieChart=new Chart(document.getElementById('factorPie').getContext('2d'),{type:'pie',data:{labels:['LPG','Temp','Humidity','Alcohol'],datasets:[{data:[0,0,0,0],backgroundColor:['#FF5722','#FFC107','#4CAF50','#2196F3']}]}});

function callEmergency(){window.location.href="tel:112";}
function triggerAlarm(riskLevel){if(riskLevel==="High"||riskLevel==="Critical"){alarm.play().catch(err=>console.log("Audio play failed",err));if("speechSynthesis" in window){window.speechSynthesis.speak(new SpeechSynthesisUtterance("Warning! "+riskLevel+" risk detected!"));}}}

function updateData(){
fetch('/data').then(res=>res.json()).then(data=>{
    const current=data.current;
    document.getElementById("lpg").innerText=current.lpg;
    document.getElementById("temp").innerText=current.temp;
    document.getElementById("humidity").innerText=current.humidity;
    document.getElementById("alcohol").innerText=current.alcohol;
    document.getElementById("b_lpg").innerText=data.breakdown.lpg;
    document.getElementById("b_temp").innerText=data.breakdown.temp;
    document.getElementById("b_humidity").innerText=data.breakdown.humidity;
    document.getElementById("b_alcohol").innerText=data.breakdown.alcohol;
    document.getElementById("riskBox").innerText=current.status+" ("+current.risk+"%)";
    document.getElementById("riskBox").style.background=current.status==="Safe"?"#4CAF50":current.status==="Moderate"?"#FFC107":current.status==="High"?"#FF5722":"#D32F2F";

    if(current.status==="High"||current.status==="Critical"){
        if(Notification.permission==="granted"){new Notification("Indoor Hazard Alert",{body:current.status+" Risk Detected. "+current.explanation});} else{Notification.requestPermission();}
        triggerAlarm(current.status);
    }

    riskHistory.push(current.risk); if(riskHistory.length>20) riskHistory.shift();
    predictedHistory.push(current.predicted_risk); if(predictedHistory.length>20) predictedHistory.shift();

    chart.data.labels=data.history.map(i=>i.time);
    chart.data.datasets[0].data=riskHistory;
    chart.data.datasets[1].data=predictedHistory;
    chart.update();

    pieChart.data.datasets[0].data=[data.breakdown.lpg,data.breakdown.temp,data.breakdown.humidity,data.breakdown.alcohol];
    pieChart.update();

    const table=document.getElementById("incidentTable"); table.innerHTML="";
    data.incident_log.forEach(entry=>{table.innerHTML+=`<tr><td>${entry.time}</td><td>${entry.status}</td><td>${entry.reason}</td></tr>`;});

    const stats=document.getElementById("stats");
    const maxRisk=Math.max(...riskHistory).toFixed(2);
    const totalAlerts=data.incident_log.length;
    stats.innerHTML=`Total Alerts: ${totalAlerts} | Max Risk: ${maxRisk}% | Predicted Risk: ${current.predicted_risk}%`;

    // Flash predicted risk warning
    if(current.predicted_risk>=80){document.getElementById("riskBox").style.animation="flash 1s infinite";} else{document.getElementById("riskBox").style.animation="";}
});}
setInterval(updateData,3000); updateData();
</script>

<style>
@keyframes flash{0%{opacity:1;}50%{opacity:0.3;}100%{opacity:1;}}
</style>
</body>
</html>
